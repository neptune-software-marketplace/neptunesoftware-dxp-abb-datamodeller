{
	"id": "e9491518-b439-ed11-a27c-e42aac61c092",
	"createdAt": "2022-09-21T13:48:38.933Z",
	"createdBy": "kristin.eliassen@neptune-software.com",
	"globalScripts": [],
	"externalModules": [
		{
			"id": "88CDE492-9935-ED11-A27C-E42AAC61C092",
			"name": "typeorm",
			"contextname": "typeorm",
			"path": "typeorm"
		}
	],
	"entitySets": [],
	"apis": [],
	"name": "tableToVisualizer",
	"ver": "22.9.28.1222",
	"description": null,
	"content": [
		"==OBJECT STRING==",
		"const data = req.body;",
		"",
		"function formatTableToX6Format(data) {",
		"",
		"    let formattedData = [];",
		"",
		"    data.forEach((table, index) => {",
		"        let formattedTable = {};",
		"",
		"        const positionX = index === 0 ? 0 : 175 * (index + 1);",
		"        const positionY = index === 0 ? 0 : 100 * (index + 1);",
		"",
		"        formattedTable.id = table.id;",
		"        formattedTable.shape = \"er-rect\";",
		"        formattedTable.label = table.name;",
		"        formattedTable.width = 250;",
		"        formattedTable.height = 24;",
		"        formattedTable.position = {",
		"            x: positionX,",
		"            y: positionY,",
		"        };",
		"",
		"        formattedTable.attrs = {",
		"            body: {",
		"                fill: '#F6B221',",
		"                stroke: '#F6B221'",
		"            },",
		"            label: {",
		"                fill: 'black'",
		"            }",
		"        }",
		"",
		"        formattedTable.ports = [];",
		"",
		"        formattedTable.ports.push({",
		"            id: `${index + 1}-1`,",
		"            group: \"list\",",
		"            attrs: {",
		"                portBody: {",
		"                    class: \"primary\"",
		"                },",
		"                portNameLabel: {",
		"                    text: \"id\",",
		"                },",
		"                portTypeLabel: {",
		"                    text: \"uuid\",",
		"                },",
		"                portPrimaryKey: {",
		"                    text: 'P'",
		"                }",
		"            },",
		"        });",
		"",
		"        table.fields.forEach((field, x) => {",
		"",
		"            const isPrimaryKey = field.isUnique && !field.isNullable;",
		"",
		"            formattedTable.ports.push({",
		"                id: `${index + 1}-${x + 2}`,",
		"                group: 'list',",
		"                attrs: {",
		"                    portBody: {",
		"                        class: isPrimaryKey ? \"primary\" : \"\"",
		"                    },",
		"                    portNameLabel: {",
		"                        text: field.fieldName,",
		"                    },",
		"                    portTypeLabel: {",
		"                        text: field.fieldType,",
		"                    },",
		"                    portPrimaryKey: {",
		"                        text: isPrimaryKey ? \"P\" : \" \"",
		"                    }",
		"                },",
		"            });",
		"        });",
		"",
		"        formattedData.push(formattedTable);",
		"    });",
		"",
		"    data.forEach((table) => {",
		"        if (table.foreignKeys.length) {",
		"            table.foreignKeys.forEach((key) => {",
		"",
		"                /*                 log.info('key')",
		"                                log.info(key) */",
		"",
		"                let formattedLink = {};",
		"                formattedLink.id = key.id;",
		"                formattedLink.shape = \"edge\";",
		"",
		"                const fromTable = formattedData.find(",
		"                    (formattedTable) => formattedTable.label === key.referencedTable",
		"                );",
		"",
		"                const toTable = formattedData.find(",
		"                    (formattedTable) => formattedTable.label === table.name",
		"                );",
		"",
		"                if (!fromTable || !toTable) return;",
		"",
		"                const linkSource = fromTable.ports.find(",
		"                    (port) =>",
		"                        port.attrs.portNameLabel.text === key.columns[0].referencedColumnName",
		"                ); //hardcoded for ONE column. Check for more",
		"",
		"                const linkTarget = toTable.ports.find(",
		"                    (port) => port.attrs.portNameLabel.text === key.columns[0].fieldName",
		"                ); //hardcoded for ONE column. Check for more",
		"",
		"",
		"                /* log.info('fromTable')",
		"                log.info(fromTable)",
		"                log.info('linkSource')",
		"                log.info(linkSource)",
		"                log.info('toTable')",
		"                log.info(toTable)",
		"                log.info('linkTarget')",
		"                log.info(linkTarget) */",
		"",
		"                formattedLink.source = {",
		"                    cell: fromTable.id, // table id",
		"                    port: linkSource.id, // e.g. 1-1",
		"                };",
		"                formattedLink.target = {",
		"                    cell: toTable.id, // table id",
		"                    port: linkTarget.id, // e.g. 2-4",
		"                };",
		"                formattedLink.attrs = {",
		"                    line: {",
		"                        stroke: \"#A2B1C3\",",
		"                        strokeWidth: 2,",
		"                    },",
		"                };",
		"                formattedLink.zIndex = 0;",
		"                formattedData.push(formattedLink);",
		"            });",
		"        }",
		"    });",
		"",
		"    return formattedData;",
		"};",
		"",
		"",
		"",
		"const tableIds = data.ids;",
		"",
		"try {",
		"    const manager = modules.typeorm.getConnection().manager;",
		"    const data = await manager.find('dictionary', { id: operators.In(tableIds) });",
		"",
		"    if (!data) {",
		"        result.data = 'Not found';",
		"        result.statusCode = 404;",
		"        return complete();",
		"    }",
		"",
		"    //const tables = data.filter(table => tableIds.includes(table.id))",
		"",
		"    const formattedData = formatTableToX6Format(data);",
		"",
		"    //log.info(formattedData);",
		"",
		"    result = {",
		"        originalData: data,",
		"        formattedData",
		"    };",
		"    complete();",
		"",
		"} catch (error) {",
		"    log.error('Error in request: ', error);",
		"    result = error;",
		"    return fail();",
		"}",
		""
	],
	"useAsGlobalScript": false,
	"isTypescript": false,
	"transpiledContent": null,
	"lastRunSuccessful": true,
	"jsscriptGroup": "92882a1c-dc0c-ed11-b47a-28187880d3e8",
	"package": "405a932e-033f-ed11-a27c-a04a5ebc99b7"
}